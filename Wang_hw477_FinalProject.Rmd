---
title: "Final Project of MSDS 597"
author: "Hui Wang"
date: "5/4/2020"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
geometry: margin=1in
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 6)
options(tinytex.verbose = TRUE)
library(dplyr)
library(tidyverse)
library(tidytext)
library(lubridate)
library(xml2)
library(rvest)
library(stringr)
library(rvest)
library(gutenbergr)   # for the text 
library(tidyr)   # for separate_rows
library(gridExtra)    #to make side-by-side figure
library(choroplethr)
library(choroplethrMaps)
library(sf)
library(scales)   # for percent()
library(dbplyr)
```

## Covid-19

```{r Covid_19}
# import the data
COVID_19_raw <- "https://www.worldometers.info/coronavirus/country/us/" %>%
  read_html() %>%
  html_table(fill=TRUE) %>%
  .[[1]]
# head(COVID_19_raw)

# extract the rows and columns needed
COVID_19_full <- data.frame(COVID_19_raw)
COVID_19_full <- COVID_19_full[-c(1,53:nrow(COVID_19_full)),]
# colnames(COVID_19_full)
COVID_19_full <- COVID_19_full %>%
  dplyr::select(USAState, TotalCases, TotalDeaths,Tot.Cases.1M.pop,Deaths.1M.pop,Tests.1M.pop) %>%
  arrange(USAState)
head(COVID_19_full)

# total cases
total_cases <- COVID_19_full %>%
  dplyr::select(USAState, TotalCases)
# match with choroplethr package
# change column name 
names(total_cases) <- c("region", "value")
# change state name to lower letter
total_cases$region <- tolower(total_cases$region)
# total_cases$region
# remove comma from value
total_cases$value <- as.numeric(gsub(",", "", total_cases$value))

# total deaths
total_deaths <- COVID_19_full %>%
  dplyr::select(USAState, TotalDeaths)
## match with choroplethr package
# change column name 
names(total_deaths) <- c("region", "value")
# change state name to lower letter
total_deaths$region <- tolower(total_deaths$region)
# remove comma from value
total_deaths$value <- as.numeric(gsub(",", "", total_deaths$value))
# fill NA with 0
total_deaths$value <- replace_na(total_deaths$value, 0)
```

```{r Covid_19 Map}
# create two side-by-side choropleth maps of COVID-19 cases and deaths in the USA
data(continental_us_states)
grid.arrange(state_choropleth(total_cases, title  = "Covid-19 toal cases in the US", zoom = continental_us_states),
             state_choropleth(total_deaths, title  = "Covid-19 toal deaths in the US", zoom = continental_us_states))
```

## Political Standing

```{r Political Standing}
# import the data
political_raw <- "https://www.nytimes.com/elections/2016/results/president" %>%
  read_html() %>%
  html_table(fill=TRUE)
political_raw

# clean table 1 and 2 by extracting the digit numbers and then divided by 100
first_two <- rbind(political_raw[[1]],political_raw[[2]]) %>%
  dplyr::select(State,Clinton,Trump,Other) %>%
  mutate(Democratic = as.numeric(gsub("[^0-9]","",Clinton))/100) %>%
  mutate(Republic = as.numeric(gsub("[^0-9]","",Trump))/100) %>%
  mutate(Other = as.numeric(gsub("[^0-9]","",Other))/100) %>%
  dplyr::select(State,Democratic,Republic,Other)

# tried the following, but it's not numueric anymore
# Democratic = percent(as.numeric(gsub("[^0-9]","",Clinton))/100)

# combine table 3 to 7, clean by extracting the digit numbers and then divided by 100
others <- rbind(political_raw[[3]],political_raw[[4]],political_raw[[5]],political_raw[[6]],political_raw[[7]]) %>%
  dplyr::select(State,Dem.,Rep.,Oth.) %>%
  mutate(Democratic = as.numeric(gsub("[^0-9]","",Dem.))/100) %>%
  mutate(Republic = as.numeric(gsub("[^0-9]","",Rep.))/100) %>%
  mutate(Other = as.numeric(gsub("[^0-9]","",Oth.))/100) %>%
  dplyr::select(State,Democratic,Republic,Other)
  
# sum = Democratic+Republic+Other is not 1 actually, checked true

# add the region names by hand, pay attendsion on such as district of colunmbia which in short is D.C. and stand after delaware, stand in front of it.
political <- rbind(first_two,others) %>%
  arrange(State) %>%
  unique() %>% 
  mutate(state = c("alabama","alaska","arizona","arkansas","california","colorado","connecticut","district of columbia","delaware","florida","georgia","hawaii","idaho","illinois","indiana","iowa","kansas","kentucky","louisiana","massachusetts","maryland","maine","michigan","minnesota","mississippi","missouri","montana","north carolina","north dakota","new hampshire","new jersey","new mexico","new york","nebraska","nevada","ohio","oklahoma","oregon","pennsylvania","rhode island","south carolina","south dakota","tennessee","texas","utah","virginia","vermont","west virginia","washington","wisconsin","wyoming"))

Dem <- political %>%
  select(state,Democratic)
names(Dem) <- c("region","value")
Rep <- political %>%
  select(state,Republic)
names(Rep) <- c("region","value")

# create two side-by-side choropleth maps of political standing in the USA in 2016 
data(continental_us_states)
grid.arrange(state_choropleth(Dem, title  = "Democratic Support in 2016", zoom = continental_us_states),
             state_choropleth(Rep, title  = "Republic Support in 2016", zoom = continental_us_states))
```

## Education

```{r Education}
# import the data
education_raw <- "https://worldpopulationreview.com/states/most-educated-states/" %>%
  read_html() %>%
  html_table(fill=TRUE) %>%
  .[[1]]

head(education_raw)   # already clean enough

# select the needed col
education <- education_raw %>%
  select(State,`Education Score`)

# change the clo names
names(education) <- c("state","education")

# lower the state col
education$state <- tolower(education$state)

names(education) <- c("region","value")
head(education)

# create a side-by-side choropleth map of education level in the USA
grid.arrange(state_choropleth(education, title  = "Education Level in US", zoom = continental_us_states))
```

## population by density

```{r Population by Density}
# import the data
pop_density_raw <- "https://simple.wikipedia.org/wiki/List_of_U.S._states_by_population_density" %>%
  read_html() %>%
  html_table(fill=TRUE) %>%
  .[[4]]
pop_density_raw

pop_density <- pop_density_raw %>%
  select(`State/Territory/Division/Region`,`2013 estimatedpopulation`,`Land area(sqmi)`,`Population/sqmi`)

# change column name 
names(pop_density) <- c("state","population","land","density")

# delete the comma and numerical the colums
pop_density$population <- as.numeric(gsub(",", "", pop_density$population))
pop_density$land <- as.numeric(gsub(",", "", pop_density$land))
pop_density$density <- as.numeric(gsub(",", "", pop_density$density))

# change state name to lower letter
pop_density$state <- tolower(pop_density$state)

# check density
pop_density_check <- pop_density %>%
  mutate(den = pop_density$population/pop_density$land)

head(pop_density)
```

## GDP

```{r GDP}
# import the data
GDP_raw <- "https://en.wikipedia.org/wiki/List_of_U.S._states_and_territories_by_GDP" %>%
  read_html() %>%
  html_table(fill=TRUE) %>%
  .[[3]]
GDP_raw

# change cols name 
names(GDP_raw) <- c("rank","state","Q4_2019","GDP_portion","GDP_perCapita","area")

# select the needed cols
GDP <- GDP_raw %>%
  select(state,Q4_2019,GDP_portion,GDP_perCapita,area)

# delete the comma and numerical the colums
GDP$Q4_2019 <- as.numeric(gsub(",", "", GDP$Q4_2019))
GDP$GDP_portion <- as.numeric(GDP$GDP_portion)
GDP$GDP_perCapita <- as.numeric(gsub(",", "", GDP$GDP_perCapita))

# change state name to lower letter
GDP$state <- tolower(GDP$state)

head(GDP)
```

## Full Table

```{r}
# political <- rbind(first_two,others) %>%

df4 <- sqldf("SELECT CustomerId, Product, State 
              FROM df1
              LEFT JOIN df2 USING(CustomerID)")

library
merge(x = COVID_19_full, y = political, by =state, all.x = TRUE)
```